{% extends 'base.html' %}
{% load format_text %}
{% block title %}{{ course.title }} - CogniWise{% endblock %}

{% block content %}
<div x-data="{ sidebarOpen: false }" class="fixed right-0 top-16 h-[calc(100vh-4rem)] z-30">
    <button @click="sidebarOpen = !sidebarOpen"
            class="absolute -left-8 top-4 w-8 h-8 bg-slate-900/90 backdrop-blur-md rounded-l-md soft-neon-border flex items-center justify-center z-40">
        <i class="fas text-emerald-300" :class="sidebarOpen ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
    </button>

    <div x-show="sidebarOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="translate-x-full opacity-0"
         x-transition:enter-end="translate-x-0 opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="translate-x-0 opacity-100"
         x-transition:leave-end="translate-x-full opacity-0"
         class="w-64 h-full bg-slate-900/95 backdrop-blur-md border-l border-slate-700/50 overflow-y-auto scrollbar-hide">

        <div class="p-4">
            <h2 class="text-lg font-bold orbitron-font soft-neon-text mb-4 flex items-center justify-between">
                <span>Содержание</span>
                <i class="fas fa-list-ul text-emerald-300"></i>
            </h2>

            <div class="space-y-3">
                {% for block in course.blocks.all %}
                <div class="bg-slate-800/50 rounded-lg p-3 soft-neon-border">
                    <div :class="{ 'text-emerald-300 soft-neon-glow': activeContent === 'block-{{ block.id }}' }"
                         class="font-medium text-white mb-2 cursor-pointer hover:text-emerald-300 transition-colors">
                        <a href="#block-{{ block.id }}" class="flex items-center justify-between">
                            <span class="flex items-center">
                                <i class="fas fa-cube mr-2 text-sm text-emerald-400"></i>
                                {{ block.title }}
                            </span>
                            <i class="fas fa-chevron-down text-xs text-slate-400"></i>
                        </a>
                    </div>

                    <div class="ml-5 space-y-1 border-l border-slate-600/50 pl-3">
                        {% for subblock in block.subblocks.all %}
                        <div :class="{ 'text-emerald-300': activeContent === 'subblock-{{ subblock.id }}' }"
                             class="text-slate-300 hover:text-emerald-300 transition-colors">
                            <a href="#subblock-{{ subblock.id }}" class="flex items-center text-sm py-1">
                                <i class="fas fa-play mr-2 text-xs text-emerald-400"></i>
                                {{ subblock.title }}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<section class="py-12 px-4 sm:py-16">
	<div :class="{ 'lg:mr-64': sidebarOpen }" class="transition-margin duration-300 pt-4">
		<div class="container mx-auto">
			<h1 class="text-3xl sm:text-4xl font-bold mb-6 text-white fade-in bg-gradient-to-r from-emerald-400 to-cyan-600 bg-clip-text text-transparent">{{ course.title }}</h1>
			<p class="text-gray-400 text-sm sm:text-base mb-8 fade-in delay-100">{{ course.description| format_text | safe }}</p>
			{% if first_block %}
				<div id="block-{{ first_block.id }}"
					 class="mb-6 p-5 border rounded-lg card-hover soft-fade-in delay-200 visible"
					 x-data="{ id: 'block-{{ first_block.id }}' }"
					 x-intersect="activeContent = id">
					<h2 class="text-lg sm:text-2xl font-semibold text-white mb-4">{{ first_block.title }}</h2>
					<div class="prose prose-invert text-sm sm:text-base">{{ first_block.content | format_text | safe }}</div>
				</div>
				{% if first_subblock %}
					<div id="subblock-{{ first_subblock.id }}"
						 class="mb-6 px-5 pb-5 bg-gray-800 border border-gray-700 rounded-lg card-hover fade-in delay-300 visible"
						 x-data="{ id: 'subblock-{{ first_subblock.id }}' }"
						 x-intersect="activeContent = id">
						<div class="ml-4 sm:ml-6 mt-3 sm:mt-4">
							<h3 class="text-base sm:text-xl font-medium text-white mb-2">{{ first_subblock.title }}</h3>
							<div class="prose prose-invert text-sm sm:text-base">{{ first_subblock.content | format_text | safe }}</div>
						</div>
					</div>
					<div hx-get="{% url 'main:load-next-content-with-subblock' course_id=course.id current_block_id=first_block.id current_subblock_id=first_subblock.id %}"
						 hx-trigger="revealed"
						 hx-swap="afterend">
					</div>
				{% else %}
					<div hx-get="{% url 'main:load-next-content' course_id=course.id current_block_id=first_block.id %}"
						 hx-trigger="revealed"
						 hx-swap="afterend">
					</div>
				{% endif %}
			{% endif %}
		</div>
	</div>
</section>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Плавная прокрутка к элементам
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Отслеживание активного контента при скролле
    function updateActiveContent() {
        const sections = document.querySelectorAll('[id^="block-"], [id^="subblock-"]');
        let currentActive = '';

        sections.forEach(section => {
            const rect = section.getBoundingClientRect();
            if (rect.top <= 100 && rect.bottom >= 100) {
                currentActive = section.id;
            }
        });

        // Обновление активного класса
        document.querySelectorAll('[class*="text-emerald-300"]').forEach(el => {
            el.classList.remove('text-emerald-300', 'soft-neon-glow');
        });

        if (currentActive) {
            const activeElement = document.querySelector(`[href="#${currentActive}"]`);
            if (activeElement) {
                activeElement.classList.add('text-emerald-300');
                activeElement.closest('.bg-slate-800\\/50').classList.add('soft-neon-glow');
            }
        }
    }

    window.addEventListener('scroll', updateActiveContent);
    updateActiveContent();
});
</script>

{% endblock %}